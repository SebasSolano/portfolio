import { useEffect, useRef } from "react";
import { gsap } from "gsap";
import { ScrollTrigger } from "gsap/ScrollTrigger";

gsap.registerPlugin(ScrollTrigger);

interface TechItem {
    name: string;
    icon: string;
}

const TECHNOLOGIES: TechItem[] = [
    {
        name: "Django",
        icon: "M11.146 0h3.924v18.166c-2.013.382-3.491.535-5.096.535-4.791 0-7.288-2.166-7.288-6.32 0-3.872 2.7-6.397 6.814-6.397.726 0 1.246.076 1.645.152V0zm0 8.464c-.38-.128-.686-.178-1.093-.178-2.013 0-3.182 1.272-3.182 3.465 0 2.141 1.118 3.312 3.182 3.312.38 0 .688-.025 1.093-.076V8.464zM21.314 0v12.594c0 3.236-.229 4.791-.916 6.141-.636 1.297-1.476 2.115-3.21 3.005L13.622 19.6c1.733-.84 2.574-1.582 3.134-2.752.586-1.195.764-2.573.764-6.066V0h3.794zm-3.924-4h3.924V4h-3.924z",
    },
    {
        name: "Laravel",
        icon: "M23.642 5.43a.364.364 0 01.014.1v5.149c0 .135-.073.26-.189.326l-4.323 2.49v4.934c0 .135-.073.26-.189.326l-9.047 5.207a.35.35 0 01-.07.029.287.287 0 01-.052.017.346.346 0 01-.167 0 .287.287 0 01-.053-.017.356.356 0 01-.07-.029L.316 18.756A.368.368 0 01.127 18.43V2.932a.336.336 0 01.014-.1.33.33 0 01.025-.071c.01-.02.023-.038.035-.057a.36.36 0 01.056-.062l4.513-2.597a.365.365 0 01.364 0L9.647 2.64a.403.403 0 01.056.063c.013.019.025.037.035.057a.33.33 0 01.025.071.336.336 0 01.014.1v9.652l3.762-2.164V5.168a.336.336 0 01.013-.1.33.33 0 01.026-.071c.01-.02.023-.038.035-.057a.36.36 0 01.056-.063l4.513-2.597a.365.365 0 01.364 0l4.513 2.597c.022.018.04.038.056.063.013.019.025.037.035.057a.33.33 0 01.026.071z",
    },
    {
        name: "React",
        icon: "M14.23 12.004a2.236 2.236 0 0 1-2.235 2.236 2.236 2.236 0 0 1-2.236-2.236 2.236 2.236 0 0 1 2.235-2.236 2.236 2.236 0 0 1 2.236 2.236zm2.648-10.69c-1.346 0-3.107.96-4.888 2.622C10.211 2.274 8.45 1.314 7.105 1.314c-.256 0-.5.034-.728.108C4.418 2.01 3.58 4.278 3.924 7.237c-2.728.906-4.47 2.325-4.47 3.764 0 1.442 1.755 2.87 4.5 3.776-.36 2.948.5 5.206 2.44 5.79.235.07.49.106.745.106 1.346 0 3.1-.962 4.873-2.622 1.77 1.648 3.526 2.608 4.867 2.608.256 0 .5-.034.73-.108 1.96-.588 2.796-2.856 2.452-5.814 2.716-.906 4.45-2.325 4.45-3.764 0-1.444-1.753-2.872-4.495-3.778.36-2.942-.498-5.204-2.438-5.788a2.35 2.35 0 0 0-.735-.108z",
    },
    {
        name: "Angular",
        icon: "M9.931 12.645h4.138l-2.07-4.908m0-7.737L.68 3.982l1.726 14.771L12 24l9.596-5.242L23.32 3.984 11.999.001zm7.064 18.31h-2.638l-1.422-3.503H8.996l-1.422 3.504h-2.64L12 2.65z",
    },
    {
        name: "Node.js",
        icon: "M11.998 24c-.321 0-.641-.084-.922-.247l-2.936-1.737c-.438-.245-.224-.332-.08-.383.585-.203.703-.25 1.328-.604.065-.037.151-.023.218.017l2.256 1.339a.29.29 0 00.272 0l8.795-5.076a.277.277 0 00.134-.238V6.921a.28.28 0 00-.137-.242L12.135 1.605a.27.27 0 00-.27 0L3.077 6.68a.282.282 0 00-.14.243v10.15a.27.27 0 00.139.235l2.409 1.392c1.307.654 2.108-.116 2.108-.89V7.787c0-.142.114-.253.256-.253h1.115c.139 0 .255.112.255.253v10.021c0 1.745-.95 2.745-2.604 2.745-.508 0-.909 0-2.026-.551L2.28 18.675A1.857 1.857 0 011.333 17.07V6.921c0-.68.363-1.313.948-1.652L11.076.191a1.93 1.93 0 011.846 0l8.794 5.078c.585.34.949.972.949 1.652v10.15a1.86 1.86 0 01-.949 1.654l-8.794 5.078a1.824 1.824 0 01-.924.247z",
    },
    {
        name: "Vue.js",
        icon: "M19.197 1.608h4.732L12 21.793.07 1.607H9.535l2.466 4.27 2.38-4.27h4.816zm-14.02 1.09l6.823 11.83L18.823 2.7h-3.12l-3.703 6.428L8.296 2.7z",
    },
    {
        name: "Nuxt",
        icon: "M13.464 20.428H2.38a2.38 2.38 0 01-2.06-3.57l6.21-10.76a1.586 1.586 0 012.748 0l1.743 3.02 2.093-3.625a1.586 1.586 0 012.748 0l5.789 10.03a2.38 2.38 0 01-2.06 3.57h-3.667m-2.44-5.905L13.464 20l6.196-10.736-2.746-4.756z",
    },
    {
        name: "Next.js",
        icon: "M11.572 0c-.176.001-.348.007-.52.019C4.856.367.198 5.472.025 11.64c-.18 6.39 4.748 11.783 11.106 12.328 6.654.57 12.394-4.338 12.845-10.89.042-.609.042-1.16.007-1.705H11.587v3.41h6.35c-.284 1.677-1.163 3.093-2.461 4.076l3.63 2.819c2.05-1.903 3.36-4.734 3.36-8.094 0-.82-.082-1.431-.164-2.014z",
    },
    {
        name: "Flutter",
        icon: "M14.314 0L2.3 12 6.13 15.84 22.115 0zM14.314 11.63L8.542 17.405 14.314 23.175 22.115 23.175 16.343 17.405 22.115 11.63z",
    },
    {
        name: "Java",
        icon: "M8.851 18.56s-.917.534.653.714c1.902.218 2.874.187 4.969-.211 0 0 .552.346 1.321.646-4.699 2.013-10.633-.118-6.943-1.149M8.276 15.933s-1.028.761.542.924c2.032.209 3.636.227 6.413-.308 0 0 .384.389.987.602-5.679 1.661-12.007.13-7.942-1.218M13.116 11.475c1.158 1.333-.304 2.533-.304 2.533s2.939-1.518 1.589-3.418c-1.261-1.772-2.228-2.652 3.007-5.688 0-.001-8.216 2.051-4.292 6.573",
    },
    {
        name: "Python",
        icon: "M14.25.18l.9.2.73.26.59.3.45.32.34.34.25.34.16.33.1.3.04.26.02.2-.01.13V8.5l-.05.63-.13.55-.21.46-.26.38-.3.31-.33.25-.35.19-.35.14-.33.1-.3.07-.26.04-.21.02H8.77l-.69.05-.59.14-.5.22-.41.27-.33.32-.27.35-.2.36-.15.37-.1.35-.07.32-.04.27-.02.21v3.06H3.17l-.21-.03-.28-.07-.32-.12-.35-.18-.36-.26-.36-.36-.35-.46-.32-.59-.28-.73-.21-.88-.14-1.05-.05-1.23.06-1.22.16-1.04.24-.87.32-.71.36-.57.4-.44.42-.33.42-.24.4-.16.36-.1.32-.05.24-.01h.16l.06.01h8.16v.96H6.18v2.11c0 .89.07 1.59.18 2.18z",
    },
    {
        name: "PHP",
        icon: "M7.01 10.207h-.944l-.515 2.648h.838c.556 0 .97-.105 1.242-.314.272-.21.455-.559.55-1.049.092-.47.05-.802-.124-.995-.175-.193-.523-.29-1.047-.29zM12 5.688C5.373 5.688 0 8.514 0 12s5.373 6.313 12 6.313S24 15.486 24 12c0-3.486-5.373-6.312-12-6.312zm-3.26 7.451c-.261.25-.644.44-1.149.568-.505.129-1.109.193-1.813.193h-.929l-.354 1.82H3.41l1.335-6.86h2.752c1.143 0 1.941.263 2.395.789.454.526.543 1.233.268 2.122a3.477 3.477 0 01-.416 1.007 3.387 3.387 0 01-.804.961z",
    },
    {
        name: "PostgreSQL",
        icon: "M23.553 14.24c-.411-1.372-1.594-1.326-2.151-1.129.117-.347.196-.673.243-1.043.179-1.402-.6-2.467-2.075-2.899.266-.456.506-.975.67-1.593.68-2.56-.123-4.788-2.154-5.612-.54-3.57-7.37-4.11-9.746-.79C6.798.773 4.944.975 3.67 2.17 2.03 3.716 1.748 5.95 2.37 8.635.816 9.324.25 10.51.454 11.965c.343 2.386 2.033 3.693 3.108 4.187-.3.727-.37 1.57-.07 2.5.478 1.47 1.544 2.2 2.737 2.492-.06 1.112.09 2.324.6 2.98.745.958 1.637.896 2.308.615.67-.282.984-.76.984-.76s-.112 1.025.603 1.577c.38.293 1.068.422 1.759.279.75-.155 1.258-.513 1.572-1.088.21-.238.587-1.127.695-3.175l.043.003.293.017c.263.013.553.013.868-.003 1.068-.046 2.378-.283 3.293-1.048 0 0-.544.517-.128 1.292.3.559 1.108 1.188 2.432 1.007 1.476-.203 2.354-1.152 2.784-2.404.163-.473.364-1.337.049-2.4z",
    },
    {
        name: "MongoDB",
        icon: "M17.193 9.555c-1.264-5.58-4.252-7.414-4.573-8.115-.28-.394-.53-.954-.735-1.44-.036.495-.055.685-.523 1.184-.723.566-4.438 3.682-4.74 10.02-.282 5.912 4.27 9.435 4.888 9.884l.07.05A73.49 73.49 0 0111.91 24h.213c.039-.653.06-1.273.066-1.862 1.912-.31 3.37-1.27 3.37-1.27s-2.335-.87-2.335-5.272c0-3.272 2.154-5.187 3.969-6.041z",
    },
    {
        name: "Firebase",
        icon: "M3.89 15.672L6.255 2.504A.467.467 0 017.21 2.3l2.47 4.617L3.89 15.672zm16.794 3.692l-2.328-14.45a.462.462 0 00-.788-.252L3.316 19.364l7.858 4.41a1.39 1.39 0 001.352 0l8.158-4.41zm-7.378-9.09l-1.802-3.446L6.31 17.806 13.306 10.274z",
    },
    {
        name: "Supabase",
        icon: "M21.362 14.975c.345.425-.095.973-.636.973h-8.658V0l9.294 14.975zM2.638 14.975C2.293 15.4 2.733 15.948 3.274 15.948h8.658V0L2.638 14.975z",
    },
    {
        name: "Dart",
        icon: "M4.105 4.105S9.158 1.58 11.684.316a3.079 3.079 0 011.481-.315s.647.058 1.199.366l8.534 4.907a1.11 1.11 0 01.553.95v9.553a1.11 1.11 0 01-.553.948L14.36 21.63c-.56.308-1.199.366-1.199.366a3.093 3.093 0 01-1.481-.315l-7.579-4.252-4.105-4.105 4.105-4.105z",
    },
];

/**
 * TechStack â€” Infinite CSS marquee carousel with persistent scroll reveal.
 */
export default function TechStack() {
    const sectionRef = useRef<HTMLElement>(null);
    const headingRef = useRef<HTMLDivElement>(null);

    useEffect(() => {
        const ctx = gsap.context(() => {
            // Heading label
            gsap.fromTo(
                headingRef.current,
                { x: -40, opacity: 0 },
                {
                    x: 0,
                    opacity: 1,
                    duration: 0.8,
                    ease: "power3.out",
                    scrollTrigger: {
                        trigger: headingRef.current,
                        start: "top 90%",
                        end: "top 20%",
                        toggleActions: "play reverse play reverse",
                    },
                }
            );

            // Marquee rows
            const rows = sectionRef.current?.querySelectorAll(".marquee-row");
            if (rows) {
                gsap.fromTo(
                    rows,
                    { opacity: 0, y: 30 },
                    {
                        opacity: 1,
                        y: 0,
                        stagger: 0.15,
                        duration: 0.8,
                        ease: "power2.out",
                        scrollTrigger: {
                            trigger: sectionRef.current,
                            start: "top 90%",
                            end: "top 15%",
                            toggleActions: "play reverse play reverse",
                        },
                    }
                );
            }
        }, sectionRef);

        return () => ctx.revert();
    }, []);

    const TechIcon = ({ tech }: { tech: TechItem }) => (
        <div className="flex items-center gap-4 px-8 py-5 glass rounded-xl whitespace-nowrap shrink-0 hover:border-accent/30 transition-all duration-300 cursor-pointer group">
            <svg
                viewBox="0 0 24 24"
                className="w-6 h-6 text-muted group-hover:text-accent transition-colors duration-300"
                fill="currentColor"
            >
                <path d={tech.icon} />
            </svg>
            <span className="font-mono text-xs text-muted group-hover:text-primary transition-colors duration-300">
                {tech.name}
            </span>
        </div>
    );

    return (
        <section
            ref={sectionRef}
            className="section-spacer overflow-hidden"
        >
            <div className="section-divider mb-16 md:mb-20" />

            <div
                ref={headingRef}
                className="max-w-7xl mx-auto section-padding mb-10 opacity-0"
            >
                <div className="flex items-center gap-4">
                    <span className="font-mono text-xs text-accent tracking-widest uppercase">
                        04
                    </span>
                    <div className="h-px w-12 bg-accent/30" />
                    <span className="font-mono text-xs text-muted tracking-widest uppercase">
                        Tech Stack
                    </span>
                </div>
            </div>

            {/* Marquee Row 1 */}
            <div className="marquee-row relative mb-6 opacity-0">
                <div className="flex gap-8 animate-marquee">
                    {[...TECHNOLOGIES, ...TECHNOLOGIES].map((tech, i) => (
                        <TechIcon key={`${tech.name}-${i}`} tech={tech} />
                    ))}
                </div>
            </div>

            {/* Marquee Row 2 */}
            <div className="marquee-row relative opacity-0">
                <div className="flex gap-8 animate-marquee-reverse">
                    {[
                        ...TECHNOLOGIES.slice().reverse(),
                        ...TECHNOLOGIES.slice().reverse(),
                    ].map((tech, i) => (
                        <TechIcon key={`${tech.name}-rev-${i}`} tech={tech} />
                    ))}
                </div>
            </div>

            {/* Fade edges */}
            <div className="absolute inset-y-0 left-0 w-24 bg-linear-to-r from-bg to-transparent z-10 pointer-events-none" />
            <div className="absolute inset-y-0 right-0 w-24 bg-linear-to-l from-bg to-transparent z-10 pointer-events-none" />
        </section>
    );
}
